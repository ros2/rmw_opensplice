set "_BUILDTIME_OSPL_HOME=@OpenSplice_HOME@/"

:: Give priority to the OSPL_HOME value used when the workspace was built, if it's valid.
:: If it's not valid, the current value of the OSPL_HOME environment variable will be used.
:: The one detected at buildtime may refer to an invalid path for users using binaries, for example.
if exist %_BUILDTIME_OSPL_HOME% (
  :: Warn about unused environment variable.
  if "%OSPL_HOME%" NEQ "" (
    if "%OSPL_HOME%" NEQ "%_BUILDTIME_OSPL_HOME%" (
      echo [opensplice_cmake_module] Warning: OSPL_HOME environment variable is set to [["%OSPL_HOME%"]] which is different to what it was set to when the workspace was built: [["%_BUILDTIME_OSPL_HOME%"]]. The latter will be used. Please be sure this is the config that you want." 1>&2
    )
  )
  set "_OSPL_HOME_TO_USE=%_BUILDTIME_OSPL_HOME%"
)
else
(
  if "%OSPL_HOME%" == "" (
    echo "[opensplice_cmake_module] Warning: OSPL_HOME value used when the workspace was built [["%_BUILDTIME_OSPL_HOME%"]] does not point to a valid directory, and the environment variable has not been overwritten. Support for opensplice will not be available." 1>&2
    set "_BUILDTIME_OSPL_HOME="
    goto :eof
  )

  if not exist %OSPL_HOME% (
    echo "[opensplice_cmake_module] Warning: neither the OSPL_HOME value used when the workspace was built [["%_BUILDTIME_OSPL_HOME%"]] nor the current OSPL_HOME environment variable [["%$OSPL_HOME%"]] point to a valid directory. Support for opensplice will not be available." 1>&2
    set "_BUILDTIME_OSPL_HOME="
    goto :eof
  )
  set "_OSPL_HOME_TO_USE=%_BUILDTIME_OSPL_HOME%"
)

call "%_OSPL_HOME_TO_USE%\release.bat" 1> nul

set "OSPL_URI=file://%AMENT_CURRENT_PREFIX%/share/opensplice_cmake_module/config/ros_ospl.xml"
set "OSPL_INFOFILE=<stdout>"
set "OSPL_ERRORFILE=<stderr>"
set OSPL_VERBOSITY=2

:: If ROS_DOMAIN_ID is not set, set it to the default of 0.
:: This is required because rmw_opensplice_cpp cannot work unless it is set.
if "%ROS_DOMAIN_ID%"=="" set ROS_DOMAIN_ID=0
set "_BUILDTIME_OSPL_HOME="
set "_OSPL_HOME_TO_USE="
